<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Artist Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #fff;
      padding: 2rem;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    h2 {
      margin-top: 2.5rem;
      font-size: 1.8rem;
      border-bottom: 2px solid #fff;
      padding-bottom: 0.3rem;
    }
    .stats {
      font-size: 1rem;
      margin-top: 0.5rem;
    }
    .cert {
      font-size: 0.9rem;
      color: gold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.5rem;
      background-color: #1a1a1a;
    }
    th, td {
      padding: 0.8rem;
      border: 1px solid #444;
      text-align: left;
      font-size: 0.95rem;
    }
    th {
      background-color: #222;
      text-transform: uppercase;
    }
    a {
      color: #4DB8FF;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    img.album-cover {
      width: 50px;
      height: 50px;
      margin-right: 10px;
      vertical-align: middle;
    }
    .summary {
      margin-top: 2rem;
      font-weight: bold;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1 id="artistName">Artist Name</h1>
  <div class="stats" id="artistStats"></div>

  <h2>Albums</h2>
  <table id="albumsTable">
    <thead>
      <tr>
        <th>Album</th>
        <th>Certification</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Songs</h2>
  <table id="songsTable">
    <thead>
      <tr>
        <th>Title</th>
        <th>Certification</th>
        <th>Streams</th>
        <th>Weeks</th>
        <th>Peak</th>
        <th>#1s</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary" id="certTotals"></div>

  <script src="weekdata.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const artistParam = params.get("artist");
    const normalize = str =>
      typeof str === "string" ? str.toUpperCase().replace(/[^A-Z0-9]/g, "").trim() : "";

    const normalizeAlbum = str => str?.toUpperCase()
      .replace(/\(.*?\)|\[.*?\]/g, "")
      .replace(/DELUXE|BONUS|VERSION|REMIX|EP|REMASTERED|EXPANDED/gi, "")
      .replace(/[^A-Z0-9]/g, "")
      .trim();

    const normalizeTitle = str => str?.toUpperCase()
      .replace(/\(.*?\)|\[.*?\]|REMIX|RADIO EDIT|FEAT\.?|FEATURING|VERSION|SINGLE/gi, "")
      .replace(/[^A-Z0-9]/g, "")
      .trim();

    function getCert(sales) {
      if (sales >= 1000) return `ðŸ’¿ Multi-Platinum x${Math.floor(sales / 500)}`;
      if (sales >= 500) return "ðŸ’¿ Platinum";
      if (sales >= 250) return "ðŸ¥‡ Gold";
      return "â€”";
    }

    function formatNumber(n) {
      if (n >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + 'B';
      if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
      if (n >= 1_000) return (n / 1_000).toFixed(0) + 'K';
      return n.toString();
    }

    document.getElementById("artistName").textContent = artistParam;

    const artistKey = normalize(artistParam);
    const albumsMap = {};
    const songsMap = {};

    for (const week in weekData) {
      weekData[week].forEach(entry => {
        const normArtist = normalize(entry.artist);
        if (normArtist !== artistKey) return;

        const normAlbum = normalizeAlbum(entry.album || "");
        const normTitle = normalizeTitle(entry.title || "");
        const sales = parseFloat(entry.sales) || 0;
        const rank = parseInt(entry.rank);
        const totalSales = parseFloat(entry.totalSales) || 0;

        // Albums
        if (entry.album && normAlbum !== "NAN") {
          if (!albumsMap[normAlbum]) {
            albumsMap[normAlbum] = {
              name: entry.album,
              sales: 0,
              image: entry.cover || ""
            };
          }
          albumsMap[normAlbum].sales += sales;
        } else if (normAlbum === "NAN") {
          const realAlbums = Object.values(albumsMap).slice(0, 3);
          const portion = sales / (realAlbums.length || 1);
          realAlbums.forEach(album => album.sales += portion);
        }

        // Songs
        if (!songsMap[normTitle]) {
          songsMap[normTitle] = {
            title: entry.title,
            artist: entry.artist,
            sales: 0,
            totalSales: 0,
            weeks: 0,
            peak: rank,
            num1s: 0
          };
        }
        const song = songsMap[normTitle];
        song.sales += sales;
        song.totalSales += totalSales;
        song.weeks += 1;
        if (rank < song.peak) song.peak = rank;
        if (rank === 1) song.num1s += 1;
      });
    }

    const albumsTable = document.querySelector("#albumsTable tbody");
    Object.values(albumsMap).sort((a, b) => b.sales - a.sales).forEach(album => {
      const cert = getCert(album.sales);
      const url = `album_detail.html?album=${encodeURIComponent(album.name)}&artist=${encodeURIComponent(artistParam)}`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><img src="https://via.placeholder.com/50?text=ðŸŽµ" class="album-cover" />
        <a href="${url}">${album.name}</a></td>
        <td class="cert">${cert}</td>`;
      albumsTable.appendChild(tr);
    });

    const songsTable = document.querySelector("#songsTable tbody");
    Object.values(songsMap).sort((a, b) => b.sales - a.sales).forEach(song => {
      const cert = getCert(song.sales);
      const url = `track_detail.html?title=${encodeURIComponent(song.title)}&artist=${encodeURIComponent(song.artist)}`;
      const streams = song.totalSales * 2.2567 * 1_000_000;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><a href="${url}">${song.title}</a></td>
        <td class="cert">${cert}</td>
        <td>${formatNumber(streams)}</td>
        <td>${song.weeks}</td>
        <td>#${song.peak}</td>
        <td>${song.num1s}</td>`;
      songsTable.appendChild(tr);
    });

    const certCounts = {};
    Object.values(albumsMap).forEach(album => {
      const cert = getCert(album.sales);
      if (!certCounts[cert]) certCounts[cert] = 0;
      certCounts[cert]++;
    });

    const certTotals = document.getElementById("certTotals");
    certTotals.innerHTML = Object.entries(certCounts)
      .filter(([c]) => c !== "â€”")
      .map(([label, count]) => `${label}: ${count}`)
      .join(" | ");

    // Artist Stats
    const artistStats = document.getElementById("artistStats");
    const songList = Object.values(songsMap);
    const num1s = songList.filter(s => s.peak === 1).length;
    const top10s = songList.filter(s => s.peak <= 10).length;
    const debuts = songList.filter(s => s.peak === s.weeks).length;
    artistStats.innerHTML = `Songs Charted: ${songList.length} | #1s: ${num1s} | Top 10s: ${top10s} | Debuts: ${debuts}`;
  </script>
</body>
</html>
