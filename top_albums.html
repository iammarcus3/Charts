<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Top Records</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 1rem;
    }
    .tabs {
      text-align: center;
      margin-bottom: 1rem;
    }
    .tabs button {
      padding: 0.6rem 1.5rem;
      margin: 0 0.5rem;
      font-size: 1rem;
      border: none;
      background-color: #ccc;
      cursor: pointer;
    }
    .tabs button.active {
      background-color: #0066cc;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background-color: #fff;
    }
    th, td {
      padding: 0.8rem;
      border: 1px solid #ccc;
      text-align: left;
      cursor: pointer;
    }
    th {
      background-color: #eee;
      text-transform: uppercase;
      font-size: 0.9rem;
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .cert {
      font-size: 0.85rem;
      color: #555;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>üé∂ Top Records of All Time</h1>
  <div class="tabs">
    <button class="active" onclick="switchTab('albums')">üèÜ Top Albums</button>
    <button onclick="switchTab('songs')">üî• Top Songs</button>
  </div>

  <!-- Album Table -->
  <table id="albumTable">
    <thead>
      <tr>
        <th data-sort="rank">Rank</th>
        <th data-sort="album">Album</th>
        <th data-sort="artist">Artist</th>
        <th data-sort="sales">Total Sales</th>
        <th data-sort="streams">Total Streams</th>
        <th data-sort="cert">Certification</th>
      </tr>
    </thead>
    <tbody id="albumBody">
      <tr><td colspan="6">Loading albums...</td></tr>
    </tbody>
  </table>

  <!-- Song Table -->
  <table id="songTable" class="hidden">
    <thead>
      <tr>
        <th data-sort="rank">Rank</th>
        <th data-sort="title">Title</th>
        <th data-sort="artist">Artist</th>
        <th data-sort="sales">Total Sales</th>
        <th data-sort="streams">Total Streams</th>
        <th data-sort="cert">Certification</th>
      </tr>
    </thead>
    <tbody id="songBody">
      <tr><td colspan="6">Loading songs...</td></tr>
    </tbody>
  </table>

  <script src="weekdata.js"></script>
  <script>
    function formatNumber(n) {
      if (n >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + 'B';
      if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
      if (n >= 1_000) return (n / 1_000).toFixed(0) + 'K';
      return n.toString();
    }

    function getCert(sales) {
      if (sales >= 1000) return `üíø Multi-Platinum x${Math.floor(sales / 500)}`;
      if (sales >= 500) return "üíø Platinum";
      if (sales >= 250) return "ü•á Gold";
      return "‚Äî";
    }

    function normalize(str) {
      return str?.toUpperCase().replace(/[^A-Z0-9]/g, "").trim();
    }

    function normalizeTitle(str) {
      return str?.toUpperCase()
        .replace(/\(.*?\)|\[.*?\]|REMIX|RADIO EDIT|FEAT\.?|FEATURING|VERSION|SINGLE/gi, "")
        .replace(/[^A-Z0-9]/g, "")
        .trim();
    }

    function normalizeAlbum(name) {
      return name?.toUpperCase()
        .replace(/\(.*?\)|\[.*?\]|DELUXE|BONUS|VERSION|REMIX|SINGLE|EP/gi, "")
        .replace(/[^A-Z0-9 ]/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function switchTab(tab) {
      document.getElementById("albumTable").classList.toggle("hidden", tab !== 'albums');
      document.getElementById("songTable").classList.toggle("hidden", tab !== 'songs');
      const buttons = document.querySelectorAll(".tabs button");
      buttons.forEach(btn => btn.classList.remove("active"));
      buttons[tab === 'albums' ? 0 : 1].classList.add("active");
    }

    window.addEventListener("DOMContentLoaded", () => {
      const albumBody = document.getElementById("albumBody");
      const songBody = document.getElementById("songBody");

      const albumMap = {};
      const songMap = {};

      for (const week in weekData) {
        const entries = weekData[week];
        entries.forEach(entry => {
          const sales = parseFloat(entry.sales) || 0;
          const normArtist = normalize(entry.artist || "");
          const normAlbum = normalizeAlbum(entry.album || "");
          const normTitle = normalizeTitle(entry.title || "");

          // Albums
          if (entry.album && entry.artist) {
            const albumKey = normAlbum + "|" + normArtist;
            if (!albumMap[albumKey]) {
              albumMap[albumKey] = {
                album: entry.album,
                artist: entry.artist,
                rawSales: 0
              };
            }
            albumMap[albumKey].rawSales += sales;
          }

          // Songs
          if (entry.title && entry.artist) {
            const songKey = normTitle + "|" + normArtist;
            if (!songMap[songKey]) {
              songMap[songKey] = {
                title: entry.title,
                artist: entry.artist,
                rawSales: 0
              };
            }
            songMap[songKey].rawSales += sales;
          }
        });
      }

      const albumList = Object.values(albumMap)
        .filter(a => a.rawSales > 0)
        .map((a, i) => ({
          ...a,
          totalSales: a.rawSales * 1000,
          totalStreams: a.rawSales * 2.2567 * 1_000_000,
          cert: getCert(a.rawSales)
        }))
        .sort((a, b) => b.totalSales - a.totalSales)
        .slice(0, 100);

      const songList = Object.values(songMap)
        .filter(s => s.rawSales > 0)
        .map((s, i) => ({
          ...s,
          totalSales: s.rawSales * 1000,
          totalStreams: s.rawSales * 2.2567 * 1_000_000,
          cert: getCert(s.rawSales)
        }))
        .sort((a, b) => b.totalSales - a.totalSales)
        .slice(0, 100);

      function renderList(data, body, isSong = false) {
        body.innerHTML = "";
        data.forEach((item, i) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${i + 1}</td>
            <td>
              <a href="${isSong
                ? `track_detail.html?title=${encodeURIComponent(item.title)}&artist=${encodeURIComponent(item.artist)}`
                : `album_detail.html?album=${encodeURIComponent(item.album)}&artist=${encodeURIComponent(item.artist)}`
              }">${isSong ? item.title : item.album}</a>
            </td>
            <td><a href="artist.html?artist=${encodeURIComponent(item.artist)}">${item.artist}</a></td>
            <td>${formatNumber(item.totalSales)}</td>
            <td>${formatNumber(item.totalStreams)}</td>
            <td class="cert">${item.cert}</td>
          `;
          body.appendChild(tr);
        });
      }

      renderList(albumList, albumBody, false);
      renderList(songList, songBody, true);

      // Add sorting to both tables
      document.querySelectorAll("table").forEach(table => {
        const tbody = table.querySelector("tbody");
        const isSong = table.id === "songTable";
        const headers = table.querySelectorAll("th[data-sort]");
        headers.forEach(header => {
          header.addEventListener("click", () => {
            const key = header.getAttribute("data-sort");
            const asc = !header.classList.contains("asc");
            headers.forEach(h => h.classList.remove("asc", "desc"));
            header.classList.add(asc ? "asc" : "desc");

            const list = isSong ? songList : albumList;
            list.sort((a, b) => {
              if (key === "title" || key === "artist" || key === "album") {
                return asc
                  ? a[key].localeCompare(b[key])
                  : b[key].localeCompare(a[key]);
              } else {
                return asc ? a[key] - b[key] : b[key] - a[key];
              }
            });

            renderList(list, tbody, isSong);
          });
        });
      });
    });
  </script>
</body>
</html>
