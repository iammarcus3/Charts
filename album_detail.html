<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Album Detail</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #fff; }
    h1 { margin-bottom: 0.5rem; }
    .error { color: red; font-weight: bold; }
    ul { padding-left: 1.5rem; }
    li { margin-bottom: 0.3rem; }
    .cert-line { margin-top: 1rem; font-size: 1.1rem; font-weight: bold; }
  </style>
</head>
<body>
  <h1 id="albumTitle">Album Detail</h1>
  <p><strong>Artist:</strong> <span id="artistName"></span></p>
  <p><strong>Total Sales:</strong> <span id="totalSales">0</span></p>
  <p><strong>Total Weeks:</strong> <span id="weeks">0</span></p>
  <p><strong>Peak Rank:</strong> <span id="peak">-</span></p>
  <p><strong>Debut Week:</strong> <span id="debut">-</span></p>
  <p class="cert-line"><strong>Certification:</strong> <span id="certification">‚Äî</span></p>

  <h2>Tracks</h2>
  <ul id="trackList"></ul>
  <p id="error" class="error"></p>

  <script src="weekdata.js"></script>
  <script>
    function normalize(str) {
      return str ? str.toUpperCase()
        .replace(/\(.*?\)|\[.*?\]|DELUXE|REMIX|VERSION|BONUS|EP/gi, '')
        .replace(/[^A-Z0-9 ]/g, '')
        .trim() : '';
    }

    function getCertification(sales) {
      if (sales >= 500) {
        const count = Math.floor(sales / 500);
        return "üíø".repeat(count) + " " + (count === 1 ? "Platinum" : `Multi-Platinum (x${count})`);
      } else if (sales >= 250) {
        return "ü•á Gold";
      }
      return "‚Äî";
    }

    const params = new URLSearchParams(location.search);
    const albumParam = params.get("album");
    const artistParam = params.get("artist");

    if (!albumParam || !artistParam) {
      document.getElementById("error").textContent = "‚ùå URL is missing album or artist parameter.";
      throw new Error("Missing ?album=...&artist=...");
    }

    const albumTitle = document.getElementById("albumTitle");
    const artistName = document.getElementById("artistName");
    const totalSalesEl = document.getElementById("totalSales");
    const weeksEl = document.getElementById("weeks");
    const peakEl = document.getElementById("peak");
    const debutEl = document.getElementById("debut");
    const certEl = document.getElementById("certification");
    const trackList = document.getElementById("trackList");

    albumTitle.textContent = albumParam;
    artistName.textContent = artistParam;

    if (typeof weekData === "undefined") {
      document.getElementById("error").textContent = "‚ùå weekdata.js is missing.";
      throw new Error("weekdata.js not loaded.");
    }

    const normAlbum = normalize(albumParam);
    const normArtist = normalize(artistParam);

    let totalSales = 0;
    let totalWeeks = 0;
    let peak = 999;
    let debutWeek = null;
    const tracks = {};

    for (const week in weekData) {
      const weekNum = parseInt(week.replace(/\D/g, ""));
      for (const row of weekData[week]) {
        if (!row.album || !row.artist || !row.title || typeof row.sales === "undefined") continue;

        if (normalize(row.album) === normAlbum && normalize(row.artist) === normArtist) {
          totalWeeks++;
          totalSales += row.sales || 0;
          if (row.rank < peak) peak = row.rank;
          if (!debutWeek || weekNum < debutWeek) debutWeek = weekNum;

          const trackKey = normalize(row.title);
          if (!tracks[trackKey]) {
            tracks[trackKey] = { title: row.title, sales: 0 };
          }
          tracks[trackKey].sales += row.sales || 0;
        }
      }
    }

    // Output
    totalSalesEl.textContent = totalSales;
    weeksEl.textContent = totalWeeks;
    peakEl.textContent = peak === 999 ? "-" : peak;
    debutEl.textContent = debutWeek || "-";
    certEl.textContent = getCertification(totalSales);

    if (totalWeeks === 0) {
      document.getElementById("error").textContent = "‚ö†Ô∏è No chart data found for this album and artist.";
    }

    const sortedTracks = Object.values(tracks).sort((a, b) => b.sales - a.sales);
    sortedTracks.forEach(track => {
      const li = document.createElement("li");
      li.textContent = `${track.title} (${track.sales})`;
      trackList.appendChild(li);
    });

    console.log("‚úÖ Album loaded:", albumParam, "| Artist:", artistParam);
    console.log("‚úÖ Matches found:", totalWeeks, "weeks");
    console.log("‚úÖ Tracks:", sortedTracks);
  </script>
</body>
</html>
