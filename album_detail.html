<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Album Detail</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #fff; color: #000; }
    h1 { margin-bottom: 0.5rem; }
    .error { color: red; font-weight: bold; }
    .cert { font-weight: bold; margin-top: 1rem; }
    ul { padding-left: 1.5rem; }
    li { margin-bottom: 0.3rem; }
    a { color: blue; text-decoration: underline; }
  </style>
</head>
<body>
  <h1><a id="albumLink" href="#">Album Detail</a></h1>
  <p><strong>Artist:</strong> <a id="artistLink" href="#">Artist</a></p>
  <p><strong>Total Sales:</strong> <span id="totalSales">0</span></p>
  <p><strong>Total Weeks:</strong> <span id="totalWeeks">0</span></p>
  <p><strong>Peak Rank:</strong> <span id="peak">-</span></p>
  <p><strong>Debut Week:</strong> <span id="debutWeek">-</span></p>
  <p class="cert"><strong>Certification:</strong> <span id="certification">â€”</span></p>

  <h2>Tracks</h2>
  <ul id="trackList"></ul>
  <p id="error" class="error"></p>

  <script src="weekdata.js"></script>
  <script>
    const params = new URLSearchParams(location.search);
    const albumParam = params.get("album");
    const artistParam = params.get("artist");

    const norm = str => str ? str.toUpperCase().replace(/[^A-Z0-9]/g, "").trim() : "";

    const normalizeAlbum = str => str
      ? str.toUpperCase()
          .replace(/\(.*?\)|\[.*?\]/g, "")
          .replace(/DELUXE|BONUS|REMIX|VERSION|EP/gi, "")
          .replace(/[^A-Z0-9]/g, "")
          .trim()
      : "";

    function getCertification(sales) {
      if (sales >= 500) {
        const count = Math.floor(sales / 500);
        return "ðŸ’¿".repeat(count) + " " + (count === 1 ? "Platinum" : `Multi-Platinum (x${count})`);
      } else if (sales >= 250) {
        return "ðŸ¥‡ Gold";
      }
      return "â€”";
    }

    // Elements
    const albumLink = document.getElementById("albumLink");
    const artistLink = document.getElementById("artistLink");
    const totalSalesEl = document.getElementById("totalSales");
    const totalWeeksEl = document.getElementById("totalWeeks");
    const peakEl = document.getElementById("peak");
    const debutEl = document.getElementById("debutWeek");
    const certEl = document.getElementById("certification");
    const trackList = document.getElementById("trackList");
    const errorEl = document.getElementById("error");

    // Set text
    albumLink.textContent = albumParam;
    albumLink.href = `album_detail.html?album=${encodeURIComponent(albumParam)}&artist=${encodeURIComponent(artistParam)}`;
    artistLink.textContent = artistParam;
    artistLink.href = `artist.html?artist=${encodeURIComponent(artistParam)}`;

    if (!window.weekData) {
      errorEl.textContent = "âŒ weekdata.js is missing or not loaded.";
      throw new Error("Missing weekdata.js");
    }

    const normArtist = norm(artistParam);
    const normAlbumKey = normalizeAlbum(albumParam);

    let totalSales = 0;
    let totalWeeks = 0;
    let peak = 999;
    let debutWeek = null;
    const tracks = {};

    for (const week in weekData) {
      const weekNum = parseInt(week.replace(/\D/g, ""));
      weekData[week].forEach(entry => {
        if (!entry.album || !entry.artist) return;
        const entryArtist = norm(entry.artist);
        const entryAlbumKey = normalizeAlbum(entry.album);
        if (entryArtist === normArtist && entryAlbumKey === normAlbumKey) {
          totalSales += entry.sales || 0;
          totalWeeks++;
          if (entry.rank && entry.rank < peak) peak = entry.rank;
          if (!debutWeek || weekNum < debutWeek) debutWeek = weekNum;

          const trackKey = norm(entry.title);
          if (!tracks[trackKey]) {
            tracks[trackKey] = { title: entry.title, sales: 0 };
          }
          tracks[trackKey].sales += entry.sales || 0;
        }
      });
    }

    totalSalesEl.textContent = totalSales;
    totalWeeksEl.textContent = totalWeeks;
    peakEl.textContent = peak === 999 ? "-" : `#${peak}`;
    debutEl.textContent = debutWeek || "-";
    certEl.textContent = getCertification(totalSales);

    const trackArray = Object.values(tracks).sort((a, b) => b.sales - a.sales);

    if (trackArray.length === 0) {
      errorEl.textContent = "âš ï¸ No tracks found. Check album and artist name match weekly data.";
    } else {
      trackArray.forEach(track => {
        const li = document.createElement("li");
        li.textContent = `${track.title} (${track.sales})`;
        trackList.appendChild(li);
      });
    }
  </script>
</body>
</html>
